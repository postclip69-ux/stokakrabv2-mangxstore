<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>STOK AKRAB V2 - MANG X STORE</title>
  <meta name="theme-color" content="#EC2028"/>

  <style>
    /* TEMA BARU: SiDompul (Merah, Putih, Abu-abu Gelap) */
    :root{
      --bg: #212121;      /* Latar belakang abu-abu gelap */
      --panel: #2d2d2d;   /* Warna panel sedikit lebih terang */
      --ink: #ffffff;     /* Teks putih */
      --muted: #aaaaaa;   /* Teks abu-abu */
      --stroke: #444444;  /* Warna garis/border */
      --brand: #EC2028;   /* Merah khas Telkomsel/SiDompul */
      --ok: #4CAF50;      /* Hijau untuk status OK */
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0; 
      color:var(--ink); 
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background-color: var(--bg);
    }

    /* Latar belakang aurora dihapus */

    /* Kontainer utama diberi padding untuk header & footer */
    .main-content {
      width: min(700px, 92vw);
      margin: 0 auto;
      /* Padding atas & bawah untuk memberi ruang bagi header & footer fixed */
      padding: 120px 0; 
    }
    
    /* HEADER: Dibuat tetap (fixed) di atas */
    .hero{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 100;
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 16px;
      text-align: center;
      background-color: var(--panel);
      box-shadow: 0 2px 10px rgba(0,0,0,.5);
    }
    
    /* Logo Dihapus */

    h1{margin:0; font-size:24px; letter-spacing:.5px; font-weight: bold;}
    .sub{font-size: 14px; color: var(--muted);}
    
    .actions{display:flex; gap:12px; padding:16px 0; flex-wrap:wrap; align-items:center; justify-content: center;}
    .btn{appearance:none; border:1px solid var(--stroke); color:var(--ink); cursor:pointer; background-color: #3e3e3e; padding:10px 14px; border-radius:8px; display:inline-flex; align-items:center; gap:8px; transition: background-color .2s;}
    .btn:hover{background-color: #505050;}
    .btn:active{transform: scale(.98);}

    .content{padding:10px 0 0}
    .meta{font-size:13px; color:var(--muted); margin-bottom:10px; display:flex; align-items:center; gap:8px}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; background-color: var(--stroke); border:1px solid var(--stroke); color:var(--ink); display:inline-flex; align-items:center; gap:8px}
    .pill.ok{background-color: var(--ok); color:white;}
    .pill.warn{background-color: var(--brand); color:white;} /* Status Gagal pakai warna merah */

    pre{
      margin:0;
      padding:16px;
      min-height:120px;
      white-space:pre-wrap;
      word-break:break-word;
      font:14px/1.65 ui-monospace,SFMono-Regular,Consolas,monospace;
      color:var(--ink);
      background-color: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 14px;
    }

    /* FOOTER: Dibuat tetap (fixed) di bawah */
    .footer{
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 100;
      padding: 12px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      background-color: var(--panel);
    }

    .toast{position:fixed; right:16px; bottom:60px; /* Ditinggikan agar tidak tertutup footer */ padding:12px 14px; border-radius:8px; background-color: var(--ok); color:white; box-shadow:0 10px 30px rgba(0,0,0,.3); opacity:0; transform: translateY(8px); pointer-events:none; transition: all .3s;}
    .toast.show{opacity:1; transform:none}

  </style>
</head>
<body>

  <header class="hero">
    <h1>MANG X STORE</h1>
    <div class="sub">STOK AKRAB V2</div>
  </header>

  <main class="main-content">
      <div class="content">
        <div id="meta" class="meta">â€”</div>
        <pre id="out">â€”</pre>
      </div>

      <div class="actions">
        <button id="copy" class="btn">ðŸ“‹ Copy</button>
        <span id="pill" class="pill">Status: <b>Belum dimuat</b></span>
      </div>
  </main>

  <footer class="footer">
    Â© MANG X STORE 2025
  </footer>

  <div id="toast" class="toast">âœ… Disalin ke clipboard</div>

  <script>
    const copyBtn = document.getElementById("copy");
    const out = document.getElementById("out");
    const meta = document.getElementById("meta");
    const pill = document.getElementById("pill");

    let lastFetch = 0;

    function setPill(text, type){
      pill.className = "pill" + (type ? " " + type : "");
      pill.innerHTML = text;
    }

    function setStateLoading(){
      meta.textContent = "Memuat stok akrab v2...";
      setPill('Status: <b>Memuatâ€¦</b>');
    }
    function setStateDone(){
      lastFetch = Date.now();
    }

    async function fetchStok(){
      // Mencegah fetch berjalan berlebihan jika tab tidak aktif
      if (document.hidden) return;

      try{
        setStateLoading();
        const r = await fetch("/api/stok?ts=" + Date.now(), { cache: "no-store" });
        const status = r.status;
        let j; try { j = await r.json(); } catch { j = null; }

        if (!r.ok || !j || j.ok === false){
          const msg = (j && (j.error || j.message)) ? j.error || j.message : "HTTP " + status;
          meta.textContent = "Gagal memuat (" + msg + "). Coba lagi.";
          setPill('Status: <b>Gagal</b>', 'warn');
          return;
        }

        let text = (j.text || "").trim();
        if (!text) text = "Stok kosong / belum tersedia.\nSilakan cek lagi nanti.";

        // Hanya update jika ada perubahan data untuk menghindari kedipan
        if (out.textContent !== text) {
            meta.textContent = j.count > 0 ? ("Ditemukan " + j.count + " item stok.") : "Stok kosong.";
            out.textContent = text;
        }
        
        setPill(j.count > 0 ? 'Status: <b class="num">'+j.count+'</b> item tersedia' : 'Status: <b>Stok kosong</b>', j.count>0 ? 'ok' : '');
      }catch(e){
        meta.textContent = "Gagal memuat (" + (e && e.message || "error") + ").";
        setPill('Status: <b>Gagal</b>', 'warn');
      }finally{
        setStateDone();
      }
    }

    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(out.textContent || "");
        toast.classList.add("show");
        setTimeout(()=>toast.classList.remove("show"), 1400);
      }catch{}
    });

    // Panggil fetchStok() saat halaman pertama kali dimuat
    document.addEventListener("DOMContentLoaded", fetchStok);
    
    // BARU: Auto-refresh data setiap 3 detik
    setInterval(fetchStok, 3000);

  </script>
</body>
</html>
